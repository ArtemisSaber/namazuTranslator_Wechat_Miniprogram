"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const class_1 = require("../../utils/class");
const util_1 = require("../../utils/util");
const app = getApp();
Page({
    data: {
        motto: 'Hello World',
        title: '大鲶鲶翻译噗',
        userInfo: {},
        hasUserInfo: false,
        canIUse: wx.canIUse('button.open-type.getUserInfo'),
        exceptionList: [],
        inputData: "",
        responseData: {},
        loading: false,
        lang: [
            { name: '中文', val: 'zh_cn' },
            { name: 'English', val: 'en_us' },
            { name: '日本語', val: 'ja_jp' }
        ],
        srcLang: [{ name: '', val: '' }],
        srcLangIndex: 0,
        tgtLang: [{ name: '', val: '' }],
        tgtLangIndex: 0,
        settings: new class_1.Setting()
    },
    bindViewTap() {
        wx.navigateTo({
            url: '../logs/logs',
        });
    },
    bindInputValue(e) {
        this.setData({
            inputData: e.detail.value
        });
    },
    onLoad() {
        if (app.globalData.userInfo) {
            this.setData({
                userInfo: app.globalData.userInfo,
                hasUserInfo: true,
            });
        }
        else if (this.data.canIUse) {
            app.userInfoReadyCallback = res => {
                this.setData({
                    userInfo: res.userInfo,
                    hasUserInfo: true,
                });
            };
        }
        else {
            wx.getUserInfo({
                success: res => {
                    app.globalData.userInfo = res.userInfo;
                    this.setData({
                        userInfo: res.userInfo,
                        hasUserInfo: true,
                    });
                },
            });
        }
        wx.showShareMenu({
            withShareTicket: true
        });
        this.initLang();
        wx.getStorage({
            key: 'dataVersion',
            success(res) {
                let data = JSON.parse(res.data);
                data = data.currentVersion[0];
                let dataVersion = util_1.getDataVersion();
                dataVersion.then((res) => {
                    if (res && res.currentVersion[0].ID !== data.ID) {
                        util_1.initAuxilaryData();
                    }
                });
            },
            fail(err) {
                console.log(err);
                util_1.initAuxilaryData();
            }
        });
    },
    performQuery() {
        let queryPromise = this.queryData();
        queryPromise.then((res) => {
            let data = this.querySuccess(new class_1.JSONResponse(res));
            wx.setStorageSync('responseData', JSON.stringify(data));
            this.setData({
                loading: false
            });
            wx.navigateTo({
                url: '../result/result'
            });
        }).catch(err => {
            this.queryError(err);
        });
    },
    verifyPayloadValid(payload) {
        for (let i = 0; i < payload.names.length; i++) {
            if (payload.names[i].length > 0) {
                return true;
            }
        }
        return false;
    },
    queryData() {
        let input = this.data.inputData;
        let settings = this.data.settings;
        let payloadData = new class_1.Payload(this.parseInputArea(settings.srcLang, input));
        if (this.verifyPayloadValid(payloadData)) {
            this.setData({ 'loading': true });
            return new Promise((resolve, reject) => {
                wx.request({
                    url: util_1.getAPIPath('item', settings.srcLang),
                    method: 'POST',
                    data: JSON.stringify(payloadData),
                    success(res) {
                        resolve(res.data);
                    },
                    fail(err) {
                        reject(err);
                    }
                });
            });
        }
        else {
            return new Promise((resolve, reject) => {
                if (false) {
                    resolve('this will never happen');
                }
                reject('invalid payload');
            });
        }
    },
    parseNotExistedItems(result) {
        let existArray = this.parseInputArea(this.data.settings.srcLang, this.data.inputData);
        for (let items in result) {
            let item = result[items][this.data.settings.srcLang];
            let index = existArray.indexOf(item);
            if (index !== -1) {
                existArray.splice(index, 1);
            }
        }
        return existArray;
    },
    queryError(err) {
        if (err === 'invalid payload') {
            wx.showToast({
                title: '请输入要翻译的物品名称',
                icon: 'none',
                duration: 2000
            });
        }
        else {
            wx.showToast({
                title: '出错了！',
                icon: "none",
                duration: 2000
            });
        }
    },
    querySuccess(data) {
        if (data.warnings.length > 0) {
            wx.setStorageSync('notExistItem', this.parseNotExistedItems(data.results).join(", "));
        }
        else {
            wx.removeStorageSync('notExistItem');
        }
        if (data.results.length > 0) {
            for (let items in data.results) {
                data.results[items]['en_us'] = util_1.parseEngUpper(data.results[items]['en_us']);
            }
        }
        return data;
    },
    initLang() {
        let settingsStr = wx.getStorageSync('settings');
        let settings;
        if (settingsStr) {
            settings = new class_1.Setting(JSON.parse(settingsStr));
        }
        else {
            settings = new class_1.Setting();
            settings.srcLang = 'zh_cn',
                settings.tgtLang = 'en_us';
            wx.setStorageSync('settings', settings);
        }
        this.setData({
            settings: settings
        });
        let langs = this.data.lang;
        let filteredTgtLang = langs;
        let filterIndex = filteredTgtLang.findIndex((ele) => {
            return ele.val === settings.srcLang;
        });
        filteredTgtLang = filteredTgtLang.slice(0, filterIndex).concat(filteredTgtLang.slice(filterIndex + 1));
        this.setData({
            srcLang: langs,
            tgtLang: filteredTgtLang
        });
        let srcLang = this.data.srcLang.findIndex((ele) => {
            return ele.val === settings.srcLang;
        });
        let tgtLang = this.data.tgtLang.findIndex((ele) => {
            return ele.val === settings.tgtLang;
        });
        this.setData({
            tgtLangIndex: tgtLang,
            srcLangIndex: srcLang
        });
    },
    changeSrcLang(e) {
        let settings = this.data.settings;
        settings.srcLang = this.data.srcLang[e.detail.value].val;
        let srcLangIndex = this.data.lang.findIndex((ele) => {
            return ele.val === settings.srcLang;
        });
        let tgtLangList = this.data.lang.slice(0, srcLangIndex).concat(this.data.lang.slice(srcLangIndex + 1));
        settings.tgtLang = tgtLangList[0].val;
        this.setData({
            srcLangIndex: e.detail.value,
            settings: settings,
            tgtLang: tgtLangList,
            tgtLangIndex: 0,
            queryInProgress: false
        });
        wx.setStorageSync('settings', JSON.stringify(settings));
    },
    changeTgtLang(e) {
        let settings = this.data.settings;
        settings.tgtLang = this.data.tgtLang[e.detail.value].val;
        this.setData({
            tgtLangIndex: e.detail.value,
            settings: settings
        });
        wx.setStorageSync('settings', JSON.stringify(settings));
    },
    getUserInfo(e) {
        console.log(e);
        app.globalData.userInfo = e.detail.userInfo;
        this.setData({
            userInfo: e.detail.userInfo,
            hasUserInfo: true,
        });
    },
    verifyExceptionItems(inputData) {
        let exceptions = wx.getStorageSync('blankItems');
        exceptions = JSON.parse(exceptions)[this.data.settings.srcLang];
        let exceptionFound = new Array();
        let content = inputData;
        for (let item in exceptions) {
            if (inputData.indexOf(exceptions[item]) !== -1 && exceptions[item].length > 0) {
                exceptionFound.push(exceptions[item]);
                content = content.replace(new RegExp(exceptions[item], "g"), "");
            }
        }
        return { "result": content, "exception": exceptionFound };
    },
    parseInputArea(sourceLang, inputData) {
        let seperator = [',', ".", '，', '、', '丨', '|', '\n'];
        if (sourceLang !== 'en_us') {
            seperator.push(' ');
        }
        let content = '';
        content = inputData;
        let resArray = new Array();
        let exceptionResult = new Array();
        for (let item in seperator) {
            if (seperator[item] === ' ') {
                let result = this.verifyExceptionItems(inputData);
                content = result.result;
                exceptionResult = result.exception;
            }
            if (resArray.length > 1) {
                break;
            }
            resArray = content.split(seperator[item]);
        }
        exceptionResult.length > 0 ? resArray = resArray.concat(exceptionResult) : '';
        resArray = resArray.map(str => str.trim());
        return resArray;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZDQUEyRTtBQUczRSwyQ0FBOEY7QUFHOUYsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFFLENBQUE7QUFFcEIsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFFLGFBQWE7UUFDcEIsS0FBSyxFQUFFLFFBQVE7UUFDZixRQUFRLEVBQUUsRUFBRTtRQUNaLFdBQVcsRUFBRSxLQUFLO1FBQ2xCLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLDhCQUE4QixDQUFDO1FBQ25ELGFBQWEsRUFBRSxFQUFFO1FBQ2pCLFNBQVMsRUFBRSxFQUFFO1FBQ2IsWUFBWSxFQUFFLEVBQUU7UUFDaEIsT0FBTyxFQUFFLEtBQUs7UUFDZCxJQUFJLEVBQUU7WUFDSixFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRTtZQUM1QixFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRTtZQUNqQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRTtTQUM5QjtRQUNELE9BQU8sRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDaEMsWUFBWSxFQUFFLENBQUM7UUFDZixPQUFPLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQ2hDLFlBQVksRUFBRSxDQUFDO1FBQ2YsUUFBUSxFQUFFLElBQUksZUFBTyxFQUFFO0tBQ3hCO0lBRUQsV0FBVztRQUNULEVBQUUsQ0FBQyxVQUFVLENBQUM7WUFDWixHQUFHLEVBQUUsY0FBYztTQUNwQixDQUFDLENBQUE7SUFDSixDQUFDO0lBQ0QsY0FBYyxDQUFDLENBQU07UUFDbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNYLFNBQVMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUs7U0FDMUIsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUNELE1BQU07UUFDSixJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFO1lBQzNCLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsUUFBUSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUTtnQkFDakMsV0FBVyxFQUFFLElBQUk7YUFDbEIsQ0FBQyxDQUFBO1NBQ0g7YUFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBRzVCLEdBQUcsQ0FBQyxxQkFBcUIsR0FBRyxHQUFHLENBQUMsRUFBRTtnQkFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFDWCxRQUFRLEVBQUUsR0FBRyxDQUFDLFFBQVE7b0JBQ3RCLFdBQVcsRUFBRSxJQUFJO2lCQUNsQixDQUFDLENBQUE7WUFDSixDQUFDLENBQUE7U0FDRjthQUFNO1lBRUwsRUFBRSxDQUFDLFdBQVcsQ0FBQztnQkFDYixPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUU7b0JBQ2IsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQTtvQkFDdEMsSUFBSSxDQUFDLE9BQU8sQ0FBQzt3QkFDWCxRQUFRLEVBQUUsR0FBRyxDQUFDLFFBQVE7d0JBQ3RCLFdBQVcsRUFBRSxJQUFJO3FCQUNsQixDQUFDLENBQUE7Z0JBQ0osQ0FBQzthQUNGLENBQUMsQ0FBQTtTQUNIO1FBQ0QsRUFBRSxDQUFDLGFBQWEsQ0FBQztZQUNmLGVBQWUsRUFBQyxJQUFJO1NBQ3JCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUNmLEVBQUUsQ0FBQyxVQUFVLENBQUM7WUFDWixHQUFHLEVBQUUsYUFBYTtZQUNsQixPQUFPLENBQUMsR0FBRztnQkFDVCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtnQkFDL0IsSUFBSSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQzdCLElBQUksV0FBVyxHQUFHLHFCQUFjLEVBQUUsQ0FBQTtnQkFDbEMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFO29CQUM1QixJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsRUFBRSxFQUFFO3dCQUMvQyx1QkFBZ0IsRUFBRSxDQUFBO3FCQUNuQjtnQkFDSCxDQUFDLENBQUMsQ0FBQTtZQUNKLENBQUM7WUFDRCxJQUFJLENBQUMsR0FBRztnQkFDTixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNoQix1QkFBZ0IsRUFBRSxDQUFBO1lBQ3BCLENBQUM7U0FDRixDQUFDLENBQUE7SUFFSixDQUFDO0lBQ0QsWUFBWTtRQUNWLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUNuQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDeEIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLG9CQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtZQUNuRCxFQUFFLENBQUMsY0FBYyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7WUFDdkQsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDWCxPQUFPLEVBQUMsS0FBSzthQUNkLENBQUMsQ0FBQTtZQUNGLEVBQUUsQ0FBQyxVQUFVLENBQUM7Z0JBQ1osR0FBRyxFQUFFLGtCQUFrQjthQUN4QixDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDYixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ3RCLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUNELGtCQUFrQixDQUFDLE9BQWdCO1FBQ2pDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUM3QyxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDL0IsT0FBTyxJQUFJLENBQUE7YUFDWjtTQUNGO1FBQ0QsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO0lBQ0QsU0FBUztRQUNQLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFBO1FBQy9CLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFBO1FBQ2pDLElBQUksV0FBVyxHQUFHLElBQUksZUFBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQzNFLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUNqQyxPQUFPLElBQUksT0FBTyxDQUE0QixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtnQkFDaEUsRUFBRSxDQUFDLE9BQU8sQ0FBQztvQkFDVCxHQUFHLEVBQUUsaUJBQVUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQztvQkFDekMsTUFBTSxFQUFFLE1BQU07b0JBQ2QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDO29CQUNqQyxPQUFPLENBQUMsR0FBRzt3QkFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO29CQUNuQixDQUFDO29CQUNELElBQUksQ0FBQyxHQUFHO3dCQUNOLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFDYixDQUFDO2lCQUNGLENBQUMsQ0FBQTtZQUNKLENBQUMsQ0FBQyxDQUFBO1NBQ0g7YUFBTTtZQUNMLE9BQU8sSUFBSSxPQUFPLENBQVMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7Z0JBQzdDLElBQUksS0FBSyxFQUFFO29CQUNULE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO2lCQUNsQztnQkFDRCxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtZQUMzQixDQUFDLENBQUMsQ0FBQTtTQUNIO0lBQ0gsQ0FBQztJQUNELG9CQUFvQixDQUFDLE1BQWtCO1FBQ3JDLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDckYsS0FBSyxJQUFJLEtBQUssSUFBSSxNQUFNLEVBQUU7WUFDeEIsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ3BELElBQUksS0FBSyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDcEMsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ2hCLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFBO2FBQzVCO1NBQ0Y7UUFDRCxPQUFPLFVBQVUsQ0FBQTtJQUNuQixDQUFDO0lBQ0QsVUFBVSxDQUFDLEdBQVE7UUFDakIsSUFBSSxHQUFHLEtBQUssaUJBQWlCLEVBQUU7WUFDN0IsRUFBRSxDQUFDLFNBQVMsQ0FBQztnQkFDWCxLQUFLLEVBQUUsYUFBYTtnQkFDcEIsSUFBSSxFQUFFLE1BQU07Z0JBQ1osUUFBUSxFQUFFLElBQUk7YUFDZixDQUFDLENBQUE7U0FDSDthQUFNO1lBQ0wsRUFBRSxDQUFDLFNBQVMsQ0FBQztnQkFDWCxLQUFLLEVBQUUsTUFBTTtnQkFDYixJQUFJLEVBQUUsTUFBTTtnQkFDWixRQUFRLEVBQUUsSUFBSTthQUNmLENBQUMsQ0FBQTtTQUNIO0lBQ0gsQ0FBQztJQUVELFlBQVksQ0FBQyxJQUFlO1FBQzFCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzVCLEVBQUUsQ0FBQyxjQUFjLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7U0FDdEY7YUFBTTtZQUNMLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsQ0FBQTtTQUNyQztRQUNELElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzNCLEtBQUssSUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDOUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxvQkFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTthQUMzRTtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDO0lBQ0QsUUFBUTtRQUNOLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDL0MsSUFBSSxRQUFnQixDQUFBO1FBQ3BCLElBQUksV0FBVyxFQUFFO1lBQ2YsUUFBUSxHQUFHLElBQUksZUFBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQTtTQUNoRDthQUNJO1lBQ0gsUUFBUSxHQUFHLElBQUksZUFBTyxFQUFFLENBQUE7WUFDeEIsUUFBUSxDQUFDLE9BQU8sR0FBRyxPQUFPO2dCQUMxQixRQUFRLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQTtZQUMxQixFQUFFLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBQyxRQUFRLENBQUMsQ0FBQTtTQUN2QztRQUNELElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxRQUFRLEVBQUUsUUFBUTtTQUNuQixDQUFDLENBQUE7UUFDRixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQTtRQUMxQixJQUFJLGVBQWUsR0FBRyxLQUFLLENBQUE7UUFDM0IsSUFBSSxXQUFXLEdBQUcsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2xELE9BQU8sR0FBRyxDQUFDLEdBQUcsS0FBSyxRQUFRLENBQUMsT0FBTyxDQUFBO1FBQ3JDLENBQUMsQ0FBQyxDQUFBO1FBQ0YsZUFBZSxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3RHLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxPQUFPLEVBQUUsS0FBSztZQUNkLE9BQU8sRUFBRSxlQUFlO1NBQ3pCLENBQUMsQ0FBQTtRQUNGLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2hELE9BQU8sR0FBRyxDQUFDLEdBQUcsS0FBSyxRQUFRLENBQUMsT0FBTyxDQUFBO1FBQ3JDLENBQUMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDaEQsT0FBTyxHQUFHLENBQUMsR0FBRyxLQUFLLFFBQVEsQ0FBQyxPQUFPLENBQUE7UUFDckMsQ0FBQyxDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsWUFBWSxFQUFFLE9BQU87WUFDckIsWUFBWSxFQUFFLE9BQU87U0FDdEIsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUNELGFBQWEsQ0FBQyxDQUFNO1FBQ2xCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFBO1FBQ2pDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUE7UUFDeEQsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDbEQsT0FBTyxHQUFHLENBQUMsR0FBRyxLQUFLLFFBQVEsQ0FBQyxPQUFPLENBQUE7UUFDckMsQ0FBQyxDQUFDLENBQUE7UUFDRixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDdEcsUUFBUSxDQUFDLE9BQU8sR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFBO1FBQ3JDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxZQUFZLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1lBQzVCLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLFlBQVksRUFBRSxDQUFDO1lBQ2YsZUFBZSxFQUFFLEtBQUs7U0FDdkIsQ0FBQyxDQUFBO1FBQ0YsRUFBRSxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO0lBQ3pELENBQUM7SUFDRCxhQUFhLENBQUMsQ0FBTTtRQUNsQixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQTtRQUNqQyxRQUFRLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFBO1FBQ3hELElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxZQUFZLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1lBQzVCLFFBQVEsRUFBRSxRQUFRO1NBQ25CLENBQUMsQ0FBQTtRQUNGLEVBQUUsQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtJQUN6RCxDQUFDO0lBQ0QsV0FBVyxDQUFDLENBQU07UUFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNkLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFBO1FBQzNDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxRQUFRLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRO1lBQzNCLFdBQVcsRUFBRSxJQUFJO1NBQ2xCLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFDRCxvQkFBb0IsQ0FBQyxTQUFpQjtRQUNwQyxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBQ2hELFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQy9ELElBQUksY0FBYyxHQUFHLElBQUksS0FBSyxFQUFVLENBQUE7UUFDeEMsSUFBSSxPQUFPLEdBQUcsU0FBUyxDQUFBO1FBQ3ZCLEtBQUssSUFBSSxJQUFJLElBQUksVUFBVSxFQUFFO1lBQzNCLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRztnQkFDOUUsY0FBYyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtnQkFDckMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO2FBQ2pFO1NBQ0Y7UUFDRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLENBQUE7SUFDM0QsQ0FBQztJQUNELGNBQWMsQ0FBQyxVQUFrQixFQUFFLFNBQWlCO1FBQ2xELElBQUksU0FBUyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDcEQsSUFBSSxVQUFVLEtBQUssT0FBTyxFQUFFO1lBQzFCLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7U0FDcEI7UUFDRCxJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUE7UUFDaEIsT0FBTyxHQUFHLFNBQVMsQ0FBQTtRQUNuQixJQUFJLFFBQVEsR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFBO1FBQ2xDLElBQUksZUFBZSxHQUFHLElBQUksS0FBSyxFQUFVLENBQUE7UUFDekMsS0FBSyxJQUFJLElBQUksSUFBSSxTQUFTLEVBQUU7WUFDMUIsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFO2dCQUMzQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUE7Z0JBQ2pELE9BQU8sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFBO2dCQUN2QixlQUFlLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQTthQUNuQztZQUNELElBQUcsUUFBUSxDQUFDLE1BQU0sR0FBRSxDQUFDLEVBQUM7Z0JBQ3BCLE1BQU07YUFDUDtZQUNELFFBQVEsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO1NBQzFDO1FBQ0QsZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7UUFDN0UsUUFBUSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQTtRQUMxQyxPQUFPLFFBQVEsQ0FBQTtJQUNqQixDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGF5bG9hZCxJUmVzcG9uc2UsSlNPTlJlc3BvbnNlLCBTZXR0aW5nIH0gZnJvbSBcIi4uLy4uL3V0aWxzL2NsYXNzXCJcbi8vIGluZGV4LnRzXG5cbmltcG9ydCB7IGdldEFQSVBhdGgsIGdldERhdGFWZXJzaW9uLCBpbml0QXV4aWxhcnlEYXRhLCBwYXJzZUVuZ1VwcGVyIH0gZnJvbSBcIi4uLy4uL3V0aWxzL3V0aWxcIlxuXG4vLyDojrflj5blupTnlKjlrp7kvotcbmNvbnN0IGFwcCA9IGdldEFwcCgpXG5cblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgbW90dG86ICdIZWxsbyBXb3JsZCcsXG4gICAgdGl0bGU6ICflpKfpsrbpsrbnv7vor5HlmZcnLFxuICAgIHVzZXJJbmZvOiB7fSxcbiAgICBoYXNVc2VySW5mbzogZmFsc2UsXG4gICAgY2FuSVVzZTogd3guY2FuSVVzZSgnYnV0dG9uLm9wZW4tdHlwZS5nZXRVc2VySW5mbycpLFxuICAgIGV4Y2VwdGlvbkxpc3Q6IFtdLFxuICAgIGlucHV0RGF0YTogXCJcIixcbiAgICByZXNwb25zZURhdGE6IHt9LFxuICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgIGxhbmc6IFtcbiAgICAgIHsgbmFtZTogJ+S4reaWhycsIHZhbDogJ3poX2NuJyB9LFxuICAgICAgeyBuYW1lOiAnRW5nbGlzaCcsIHZhbDogJ2VuX3VzJyB9LFxuICAgICAgeyBuYW1lOiAn5pel5pys6KqeJywgdmFsOiAnamFfanAnIH1cbiAgICBdLFxuICAgIHNyY0xhbmc6IFt7IG5hbWU6ICcnLCB2YWw6ICcnIH1dLFxuICAgIHNyY0xhbmdJbmRleDogMCxcbiAgICB0Z3RMYW5nOiBbeyBuYW1lOiAnJywgdmFsOiAnJyB9XSxcbiAgICB0Z3RMYW5nSW5kZXg6IDAsXG4gICAgc2V0dGluZ3M6IG5ldyBTZXR0aW5nKClcbiAgfSxcbiAgLy8g5LqL5Lu25aSE55CG5Ye95pWwXG4gIGJpbmRWaWV3VGFwKCkge1xuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnLi4vbG9ncy9sb2dzJyxcbiAgICB9KVxuICB9LFxuICBiaW5kSW5wdXRWYWx1ZShlOiBhbnkpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgaW5wdXREYXRhOiBlLmRldGFpbC52YWx1ZVxuICAgIH0pXG4gIH0sXG4gIG9uTG9hZCgpIHtcbiAgICBpZiAoYXBwLmdsb2JhbERhdGEudXNlckluZm8pIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHVzZXJJbmZvOiBhcHAuZ2xvYmFsRGF0YS51c2VySW5mbyxcbiAgICAgICAgaGFzVXNlckluZm86IHRydWUsXG4gICAgICB9KVxuICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhLmNhbklVc2UpIHtcbiAgICAgIC8vIOeUseS6jiBnZXRVc2VySW5mbyDmmK/nvZHnu5zor7fmsYLvvIzlj6/og73kvJrlnKggUGFnZS5vbkxvYWQg5LmL5ZCO5omN6L+U5ZueXG4gICAgICAvLyDmiYDku6XmraTlpITliqDlhaUgY2FsbGJhY2sg5Lul6Ziy5q2i6L+Z56eN5oOF5Ya1XG4gICAgICBhcHAudXNlckluZm9SZWFkeUNhbGxiYWNrID0gcmVzID0+IHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICB1c2VySW5mbzogcmVzLnVzZXJJbmZvLFxuICAgICAgICAgIGhhc1VzZXJJbmZvOiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyDlnKjmsqHmnIkgb3Blbi10eXBlPWdldFVzZXJJbmZvIOeJiOacrOeahOWFvOWuueWkhOeQhlxuICAgICAgd3guZ2V0VXNlckluZm8oe1xuICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgIGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvID0gcmVzLnVzZXJJbmZvXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHVzZXJJbmZvOiByZXMudXNlckluZm8sXG4gICAgICAgICAgICBoYXNVc2VySW5mbzogdHJ1ZSxcbiAgICAgICAgICB9KVxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICB9XG4gICAgd3guc2hvd1NoYXJlTWVudSh7XG4gICAgICB3aXRoU2hhcmVUaWNrZXQ6dHJ1ZVxuICAgIH0pXG4gICAgdGhpcy5pbml0TGFuZygpXG4gICAgd3guZ2V0U3RvcmFnZSh7XG4gICAgICBrZXk6ICdkYXRhVmVyc2lvbicsXG4gICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICBsZXQgZGF0YSA9IEpTT04ucGFyc2UocmVzLmRhdGEpXG4gICAgICAgIGRhdGEgPSBkYXRhLmN1cnJlbnRWZXJzaW9uWzBdXG4gICAgICAgIGxldCBkYXRhVmVyc2lvbiA9IGdldERhdGFWZXJzaW9uKClcbiAgICAgICAgZGF0YVZlcnNpb24udGhlbigocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICBpZiAocmVzICYmIHJlcy5jdXJyZW50VmVyc2lvblswXS5JRCAhPT0gZGF0YS5JRCkge1xuICAgICAgICAgICAgaW5pdEF1eGlsYXJ5RGF0YSgpXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSxcbiAgICAgIGZhaWwoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgaW5pdEF1eGlsYXJ5RGF0YSgpXG4gICAgICB9XG4gICAgfSlcblxuICB9LFxuICBwZXJmb3JtUXVlcnkoKSB7XG4gICAgbGV0IHF1ZXJ5UHJvbWlzZSA9IHRoaXMucXVlcnlEYXRhKClcbiAgICBxdWVyeVByb21pc2UudGhlbigocmVzKSA9PiB7XG4gICAgICBsZXQgZGF0YSA9IHRoaXMucXVlcnlTdWNjZXNzKG5ldyBKU09OUmVzcG9uc2UocmVzKSlcbiAgICAgIHd4LnNldFN0b3JhZ2VTeW5jKCdyZXNwb25zZURhdGEnLCBKU09OLnN0cmluZ2lmeShkYXRhKSlcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIGxvYWRpbmc6ZmFsc2VcbiAgICAgIH0pXG4gICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgdXJsOiAnLi4vcmVzdWx0L3Jlc3VsdCdcbiAgICAgIH0pXG4gICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgIHRoaXMucXVlcnlFcnJvcihlcnIpXG4gICAgfSlcbiAgfSxcbiAgdmVyaWZ5UGF5bG9hZFZhbGlkKHBheWxvYWQ6IFBheWxvYWQpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBheWxvYWQubmFtZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChwYXlsb2FkLm5hbWVzW2ldLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlXG4gIH0sXG4gIHF1ZXJ5RGF0YSgpIHtcbiAgICBsZXQgaW5wdXQgPSB0aGlzLmRhdGEuaW5wdXREYXRhXG4gICAgbGV0IHNldHRpbmdzID0gdGhpcy5kYXRhLnNldHRpbmdzXG4gICAgbGV0IHBheWxvYWREYXRhID0gbmV3IFBheWxvYWQodGhpcy5wYXJzZUlucHV0QXJlYShzZXR0aW5ncy5zcmNMYW5nLCBpbnB1dCkpXG4gICAgaWYgKHRoaXMudmVyaWZ5UGF5bG9hZFZhbGlkKHBheWxvYWREYXRhKSkge1xuICAgICAgdGhpcy5zZXREYXRhKHsgJ2xvYWRpbmcnOiB0cnVlIH0pXG4gICAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nfFJlY29yZDxzdHJpbmcsYW55Pj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICB3eC5yZXF1ZXN0KHtcbiAgICAgICAgICB1cmw6IGdldEFQSVBhdGgoJ2l0ZW0nLCBzZXR0aW5ncy5zcmNMYW5nKSxcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShwYXlsb2FkRGF0YSksXG4gICAgICAgICAgc3VjY2VzcyhyZXMpIHtcbiAgICAgICAgICAgIHJlc29sdmUocmVzLmRhdGEpXG4gICAgICAgICAgfSxcbiAgICAgICAgICBmYWlsKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGlmIChmYWxzZSkge1xuICAgICAgICAgIHJlc29sdmUoJ3RoaXMgd2lsbCBuZXZlciBoYXBwZW4nKVxuICAgICAgICB9XG4gICAgICAgIHJlamVjdCgnaW52YWxpZCBwYXlsb2FkJylcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuICBwYXJzZU5vdEV4aXN0ZWRJdGVtcyhyZXN1bHQ6IEFycmF5PGFueT4pIHtcbiAgICBsZXQgZXhpc3RBcnJheSA9IHRoaXMucGFyc2VJbnB1dEFyZWEodGhpcy5kYXRhLnNldHRpbmdzLnNyY0xhbmcsIHRoaXMuZGF0YS5pbnB1dERhdGEpXG4gICAgZm9yIChsZXQgaXRlbXMgaW4gcmVzdWx0KSB7XG4gICAgICBsZXQgaXRlbSA9IHJlc3VsdFtpdGVtc11bdGhpcy5kYXRhLnNldHRpbmdzLnNyY0xhbmddXG4gICAgICBsZXQgaW5kZXggPSBleGlzdEFycmF5LmluZGV4T2YoaXRlbSlcbiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgZXhpc3RBcnJheS5zcGxpY2UoaW5kZXgsIDEpXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBleGlzdEFycmF5XG4gIH0sXG4gIHF1ZXJ5RXJyb3IoZXJyOiBhbnkpIHtcbiAgICBpZiAoZXJyID09PSAnaW52YWxpZCBwYXlsb2FkJykge1xuICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgdGl0bGU6ICfor7fovpPlhaXopoHnv7vor5HnmoTnianlk4HlkI3np7AnLFxuICAgICAgICBpY29uOiAnbm9uZScsXG4gICAgICAgIGR1cmF0aW9uOiAyMDAwXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICB0aXRsZTogJ+WHuumUmeS6hu+8gScsXG4gICAgICAgIGljb246IFwibm9uZVwiLFxuICAgICAgICBkdXJhdGlvbjogMjAwMFxuICAgICAgfSlcbiAgICB9XG4gIH0sXG5cbiAgcXVlcnlTdWNjZXNzKGRhdGE6IElSZXNwb25zZSkge1xuICAgIGlmIChkYXRhLndhcm5pbmdzLmxlbmd0aCA+IDApIHtcbiAgICAgIHd4LnNldFN0b3JhZ2VTeW5jKCdub3RFeGlzdEl0ZW0nLCB0aGlzLnBhcnNlTm90RXhpc3RlZEl0ZW1zKGRhdGEucmVzdWx0cykuam9pbihcIiwgXCIpKVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5yZW1vdmVTdG9yYWdlU3luYygnbm90RXhpc3RJdGVtJylcbiAgICB9XG4gICAgaWYgKGRhdGEucmVzdWx0cy5sZW5ndGggPiAwKSB7XG4gICAgICBmb3IgKGxldCBpdGVtcyBpbiBkYXRhLnJlc3VsdHMpIHtcbiAgICAgICAgZGF0YS5yZXN1bHRzW2l0ZW1zXVsnZW5fdXMnXSA9IHBhcnNlRW5nVXBwZXIoZGF0YS5yZXN1bHRzW2l0ZW1zXVsnZW5fdXMnXSlcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRhdGFcbiAgfSxcbiAgaW5pdExhbmcoKSB7XG4gICAgbGV0IHNldHRpbmdzU3RyID0gd3guZ2V0U3RvcmFnZVN5bmMoJ3NldHRpbmdzJylcbiAgICBsZXQgc2V0dGluZ3M6U2V0dGluZ1xuICAgIGlmIChzZXR0aW5nc1N0cikge1xuICAgICAgc2V0dGluZ3MgPSBuZXcgU2V0dGluZyhKU09OLnBhcnNlKHNldHRpbmdzU3RyKSlcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBzZXR0aW5ncyA9IG5ldyBTZXR0aW5nKClcbiAgICAgIHNldHRpbmdzLnNyY0xhbmcgPSAnemhfY24nLFxuICAgICAgc2V0dGluZ3MudGd0TGFuZyA9ICdlbl91cydcbiAgICAgIHd4LnNldFN0b3JhZ2VTeW5jKCdzZXR0aW5ncycsc2V0dGluZ3MpXG4gICAgfVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBzZXR0aW5nczogc2V0dGluZ3NcbiAgICB9KVxuICAgIGxldCBsYW5ncyA9IHRoaXMuZGF0YS5sYW5nXG4gICAgbGV0IGZpbHRlcmVkVGd0TGFuZyA9IGxhbmdzXG4gICAgbGV0IGZpbHRlckluZGV4ID0gZmlsdGVyZWRUZ3RMYW5nLmZpbmRJbmRleCgoZWxlKSA9PiB7XG4gICAgICByZXR1cm4gZWxlLnZhbCA9PT0gc2V0dGluZ3Muc3JjTGFuZ1xuICAgIH0pXG4gICAgZmlsdGVyZWRUZ3RMYW5nID0gZmlsdGVyZWRUZ3RMYW5nLnNsaWNlKDAsIGZpbHRlckluZGV4KS5jb25jYXQoZmlsdGVyZWRUZ3RMYW5nLnNsaWNlKGZpbHRlckluZGV4ICsgMSkpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIHNyY0xhbmc6IGxhbmdzLFxuICAgICAgdGd0TGFuZzogZmlsdGVyZWRUZ3RMYW5nXG4gICAgfSlcbiAgICBsZXQgc3JjTGFuZyA9IHRoaXMuZGF0YS5zcmNMYW5nLmZpbmRJbmRleCgoZWxlKSA9PiB7XG4gICAgICByZXR1cm4gZWxlLnZhbCA9PT0gc2V0dGluZ3Muc3JjTGFuZ1xuICAgIH0pXG4gICAgbGV0IHRndExhbmcgPSB0aGlzLmRhdGEudGd0TGFuZy5maW5kSW5kZXgoKGVsZSkgPT4ge1xuICAgICAgcmV0dXJuIGVsZS52YWwgPT09IHNldHRpbmdzLnRndExhbmdcbiAgICB9KVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICB0Z3RMYW5nSW5kZXg6IHRndExhbmcsXG4gICAgICBzcmNMYW5nSW5kZXg6IHNyY0xhbmdcbiAgICB9KVxuICB9LFxuICBjaGFuZ2VTcmNMYW5nKGU6IGFueSkge1xuICAgIGxldCBzZXR0aW5ncyA9IHRoaXMuZGF0YS5zZXR0aW5nc1xuICAgIHNldHRpbmdzLnNyY0xhbmcgPSB0aGlzLmRhdGEuc3JjTGFuZ1tlLmRldGFpbC52YWx1ZV0udmFsXG4gICAgbGV0IHNyY0xhbmdJbmRleCA9IHRoaXMuZGF0YS5sYW5nLmZpbmRJbmRleCgoZWxlKSA9PiB7XG4gICAgICByZXR1cm4gZWxlLnZhbCA9PT0gc2V0dGluZ3Muc3JjTGFuZ1xuICAgIH0pXG4gICAgbGV0IHRndExhbmdMaXN0ID0gdGhpcy5kYXRhLmxhbmcuc2xpY2UoMCwgc3JjTGFuZ0luZGV4KS5jb25jYXQodGhpcy5kYXRhLmxhbmcuc2xpY2Uoc3JjTGFuZ0luZGV4ICsgMSkpXG4gICAgc2V0dGluZ3MudGd0TGFuZyA9IHRndExhbmdMaXN0WzBdLnZhbFxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBzcmNMYW5nSW5kZXg6IGUuZGV0YWlsLnZhbHVlLFxuICAgICAgc2V0dGluZ3M6IHNldHRpbmdzLFxuICAgICAgdGd0TGFuZzogdGd0TGFuZ0xpc3QsXG4gICAgICB0Z3RMYW5nSW5kZXg6IDAsXG4gICAgICBxdWVyeUluUHJvZ3Jlc3M6IGZhbHNlXG4gICAgfSlcbiAgICB3eC5zZXRTdG9yYWdlU3luYygnc2V0dGluZ3MnLCBKU09OLnN0cmluZ2lmeShzZXR0aW5ncykpXG4gIH0sXG4gIGNoYW5nZVRndExhbmcoZTogYW55KSB7XG4gICAgbGV0IHNldHRpbmdzID0gdGhpcy5kYXRhLnNldHRpbmdzXG4gICAgc2V0dGluZ3MudGd0TGFuZyA9IHRoaXMuZGF0YS50Z3RMYW5nW2UuZGV0YWlsLnZhbHVlXS52YWxcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgdGd0TGFuZ0luZGV4OiBlLmRldGFpbC52YWx1ZSxcbiAgICAgIHNldHRpbmdzOiBzZXR0aW5nc1xuICAgIH0pXG4gICAgd3guc2V0U3RvcmFnZVN5bmMoJ3NldHRpbmdzJywgSlNPTi5zdHJpbmdpZnkoc2V0dGluZ3MpKVxuICB9LFxuICBnZXRVc2VySW5mbyhlOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZyhlKVxuICAgIGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvID0gZS5kZXRhaWwudXNlckluZm9cbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgdXNlckluZm86IGUuZGV0YWlsLnVzZXJJbmZvLFxuICAgICAgaGFzVXNlckluZm86IHRydWUsXG4gICAgfSlcbiAgfSxcbiAgdmVyaWZ5RXhjZXB0aW9uSXRlbXMoaW5wdXREYXRhOiBzdHJpbmcpIHtcbiAgICBsZXQgZXhjZXB0aW9ucyA9IHd4LmdldFN0b3JhZ2VTeW5jKCdibGFua0l0ZW1zJylcbiAgICBleGNlcHRpb25zID0gSlNPTi5wYXJzZShleGNlcHRpb25zKVt0aGlzLmRhdGEuc2V0dGluZ3Muc3JjTGFuZ11cbiAgICBsZXQgZXhjZXB0aW9uRm91bmQgPSBuZXcgQXJyYXk8c3RyaW5nPigpXG4gICAgbGV0IGNvbnRlbnQgPSBpbnB1dERhdGFcbiAgICBmb3IgKGxldCBpdGVtIGluIGV4Y2VwdGlvbnMpIHtcbiAgICAgIGlmIChpbnB1dERhdGEuaW5kZXhPZihleGNlcHRpb25zW2l0ZW1dKSAhPT0gLTEgJiYgZXhjZXB0aW9uc1tpdGVtXS5sZW5ndGggPiAwICkge1xuICAgICAgICBleGNlcHRpb25Gb3VuZC5wdXNoKGV4Y2VwdGlvbnNbaXRlbV0pXG4gICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UobmV3IFJlZ0V4cChleGNlcHRpb25zW2l0ZW1dLCBcImdcIiksIFwiXCIpXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7IFwicmVzdWx0XCI6IGNvbnRlbnQsIFwiZXhjZXB0aW9uXCI6IGV4Y2VwdGlvbkZvdW5kIH1cbiAgfSxcbiAgcGFyc2VJbnB1dEFyZWEoc291cmNlTGFuZzogc3RyaW5nLCBpbnB1dERhdGE6IHN0cmluZykge1xuICAgIGxldCBzZXBlcmF0b3IgPSBbJywnLCBcIi5cIiwgJ++8jCcsICfjgIEnLCAn5LioJywgJ3wnLCAnXFxuJ11cbiAgICBpZiAoc291cmNlTGFuZyAhPT0gJ2VuX3VzJykge1xuICAgICAgc2VwZXJhdG9yLnB1c2goJyAnKVxuICAgIH1cbiAgICBsZXQgY29udGVudCA9ICcnXG4gICAgY29udGVudCA9IGlucHV0RGF0YVxuICAgIGxldCByZXNBcnJheSA9IG5ldyBBcnJheTxzdHJpbmc+KClcbiAgICBsZXQgZXhjZXB0aW9uUmVzdWx0ID0gbmV3IEFycmF5PHN0cmluZz4oKVxuICAgIGZvciAobGV0IGl0ZW0gaW4gc2VwZXJhdG9yKSB7XG4gICAgICBpZiAoc2VwZXJhdG9yW2l0ZW1dID09PSAnICcpIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHRoaXMudmVyaWZ5RXhjZXB0aW9uSXRlbXMoaW5wdXREYXRhKVxuICAgICAgICBjb250ZW50ID0gcmVzdWx0LnJlc3VsdFxuICAgICAgICBleGNlcHRpb25SZXN1bHQgPSByZXN1bHQuZXhjZXB0aW9uXG4gICAgICB9XG4gICAgICBpZihyZXNBcnJheS5sZW5ndGggPjEpe1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIHJlc0FycmF5ID0gY29udGVudC5zcGxpdChzZXBlcmF0b3JbaXRlbV0pXG4gICAgfVxuICAgIGV4Y2VwdGlvblJlc3VsdC5sZW5ndGggPiAwID8gcmVzQXJyYXkgPSByZXNBcnJheS5jb25jYXQoZXhjZXB0aW9uUmVzdWx0KSA6ICcnXG4gICAgcmVzQXJyYXkgPSByZXNBcnJheS5tYXAoc3RyID0+IHN0ci50cmltKCkpXG4gICAgcmV0dXJuIHJlc0FycmF5XG4gIH1cbn0pXG4iXX0=